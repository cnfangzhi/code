### 什么是热修复

Ø热修复是面向移动设备的线上修复服务，为APP线上版本提供静默更新，细粒度修复能力。帮助开发者实时修复线上问题，敏捷发布轻量级功能。



### 为什么使用热修复？

在Andorid应用开发中，由于机型碎片化，线上环境复杂多样化，APP发布后总会遇到一些开发环境无法测试覆盖的缺陷：崩溃、数据错误、逻辑异常等等一系列的问题。

传统处理方式，定位问题，修复问题，发布新的版本。这种方式，一方面会让APP频繁更新，用户体验不好；另外由于AppStore审核机制，发布周期一般需要1-2天左右，修复问题时间成本高。最终导致客户流失，资损等严重后果。尤其是月活百万以上后，全部客户更新完成往往需要一周以上，甚至更长的时间。

热修复解决能够很好解决上述面临的问题：无需APP升级版本，通过补丁下发，即可静默方式完成线上变更：

- 快速修复线上Bug。
- 轻量级功能发布。



### 热修复产品组成

SDK：集成在手机APP中，用于客户端上补丁查询请求，加载管理。

管理控制台：开发者通过控制台操作，进行变更管理，构建生成Patch，管理，发布，查看数据监控统计等。

后端服务：承载来自SDK的请求及管理控制台操作的后端服务。



### 怎么进行热修复

生成相应的补丁包，并上传到服务端进行管理。

App判断下载最新补丁，执行热修复。



### 热修复使用到的技术

- ClassLoader
- Dex动态加载技术
- hook，反射
- 差分打包技术
- 字节码插桩技术：ASM， Javassit
- Gradle插件技术
- 编译生成so库技术
- ...



### 主流热修复框架对比

热修复框架有很多，原理也有一定的区别，但是总体的设计思路都大同小异。

![](pic\主流热修复框架对比.png)



### AndFix

在native动态替换java层的方法，通过native层hook java层代码。

![](pic\AndFix.png)

### Robust

对每个方法都在编译的时候自动插入了一段代码。通过判断是否执行插入的抽象代码逻辑，有点类似于代理。使用到了编译时字节码插桩技术。



### Tinker/QZone

生成新的补丁包，动态加载补丁中dex，通过类加载机制，重新加载修复了问题的类。



### 要解决的问题

怎么进行差分打包？

怎么把新的dex包加载进来？

Gradle插件实现这个编译时插桩。

Gradle插件实现自动化差分打包。



### Android ClassLoader

Android与Java的类加载机制区别不大，但是Andorid SDK实现了自己的ClassLoader。

触发类加载条件：

1. new XXX()
2. 当class当中这个静态变量和方法被调用
3. 使用反射的时候
4. classloader.loadClass()

![](pic\Android_ClassLoader.png)



### 双亲委派机制

在Java中，类加载遵循双亲委派机制：

- 某个类加载器加载类时，首先将下载任务委派给父加载器，依次递归，如果父加载器可以完成类加载任务，就成功返回；只有父加载器无法完成加载任务或者没有父加载器时，才自己去加载。

为什么要使用双亲委派？

- 避免重复加载，当父加载器已经加载了该类的时候，就没必要子加载器去加载了。
- 安全性考虑，防止核心API库被随意替换。



### bsdiff

bsdiff hello.txt hello_v2.txt path

bspatchhello.txt hello_new.txt path



















